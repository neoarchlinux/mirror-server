services:
  arch-php:
    build:
      context: ./images
      dockerfile: arch-php.Dockerfile
    container_name: mirrors.neoarchlinux.org_php
    volumes:
      - ./php:/var/www/html:rw
      - ./mirrors:/var/mirrors:rw
      - ./gnupg:/srv/http/.gnupg:rw
    environment:
      - TIMEZONE=${TIMEZONE}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
    restart: unless-stopped
    networks:
      - mirrors.neoarchlinux.org
    user: "0:0"

  nginx:
    image: nginx:stable-alpine
    container_name: mirrors.neoarchlinux.org_nginx
    depends_on:
      - arch-php
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./php:/var/www/html:ro
      - ./mirrors:/var/mirrors:rw
      - ./nginx/log:/var/log/nginx:rw
      - ./nginx/ssl:/etc/nginx/ssl:ro
    restart: unless-stopped
    networks:
      - mirrors.neoarchlinux.org

  postgres:
    image: postgres:18-alpine
    container_name: mirrors.neoarchlinux.org_postgres
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASS}
    volumes:
      - neoarch_pgdata:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - mirrors.neoarchlinux.org

volumes:
  neoarch_pgdata:

networks:
  mirrors.neoarchlinux.org:
    external: true
